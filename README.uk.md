# AI Крипто Ф'ючерсний Інтрадей Сканер

AI-сканер для інтрадей-трейдингу криптовалютних ф'ючерсів на Binance. Поєднує навчений **ML ансамбль (XGBoost + LightGBM + CatBoost)** з **аналізом OpenAI LLM** (гібридний підхід) для генерації торгових сигналів із точками входу, стоп-лосом та тейк-профітом.

## Як це працює

```
Binance Futures API          CoinGecko API
     │                            │
     ▼                            ▼
┌─────────────┐          ┌───────────────┐
│ OHLCV дані  │          │ USDT/USDC Dom │
│ OI, L/S     │          │ Total MCap    │
│ Funding Rate│          │ Stablecoin %  │
│ Order Book  │          └───────┬───────┘
└──────┬──────┘                  │
       │                         │
       ▼                         ▼
┌──────────────────────────────────────┐
│       Технічні індикатори             │
│  RSI, MACD, Bollinger, EMA, ATR,     │
│  ADX, StochRSI, OBV, Volume Ratio    │
└──────────────────┬───────────────────┘
                   │
       ┌───────────┴───────────┐
       ▼                       ▼
┌─────────────┐        ┌─────────────┐
│  ML движок  │        │  LLM движок │
│  (Ensemble) │        │  (GPT-4o)   │
│             │        │             │
│  37 фічей   │        │ Повний      │
│  3 класи    │        │ ринковий    │
│  BUY/SELL/  │        │ контекст +  │
│  HOLD       │        │ framework   │
│  Вага: 60%  │        │  Вага: 40%  │
└──────┬──────┘        └──────┬──────┘
       │                      │
       └──────────┬───────────┘
                  ▼
       ┌───────────────────┐
       │ Фільтри сигналів  │
       │ Volume, ADX, EMA, │
       │ Order Book, NYSE  │
       └────────┬──────────┘
                ▼
       ┌───────────────────┐
       │ 1m Entry Refiner  │
       │ EMA/BB/RSI touch  │
       └────────┬──────────┘
                ▼
       ┌───────────────────┐
       │ Сигнал            │
       │ FRESH / NEW / LATE│
       │ Entry, SL, TP     │
       └───────────────────┘
```

## Можливості

### Мультипарний сканер
- Сканує **10 топових ф'ючерсних пар** одночасно (BTC, ETH, BNB, SOL, XRP, DOGE, ADA, AVAX, LINK, DOT)
- Список пар налаштовується в `src/config.py`

### Мультитаймфреймовий аналіз
- **Основний (5m)** — генерація сигналів, 21 базова технічна фіча
- **Підтверджуючий (15m)** — 6 фічей вищого ТФ
- **Трендовий (1h)** — макро трендовий фільтр, 6 фічей вищого ТФ

### Технічні індикатори (21+)
RSI, MACD (лінія + гістограма), Bollinger Bands (%B), EMA (9/21/50), ATR, ADX (з DMP/DMN), Stochastic RSI, OBV, Volume Ratio, перетини EMA, зміни ціни (1/5/15 барів), анатомія свічки (тіло, тіні), дивергенція RSI

### Ринковий контекст
| Дані | Джерело | Призначення |
|------|---------|-------------|
| Open Interest + історія | Binance `/futures/data/` | Переконаність ринку, тренд зміни OI |
| Long/Short Ratio | Binance `/futures/data/` | Позиціонування натовпу (контраріанський сигнал) |
| Funding Rate | Binance Futures API | Вартість утримання, сентимент |
| Order Book Imbalance | Binance `/fapi/v1/depth` | Bid/ask тиск, детекція стін |
| USDT Домінація | CoinGecko `/global` | Risk-on/off сентимент |
| USDC Домінація | CoinGecko `/global` | Інституційний потік |
| Загальна домінація стейблів | CoinGecko `/global` | Потік грошей в/з крипти |
| Загальна капіталізація | CoinGecko `/global` | Загальне здоров'я ринку |
| Зони ліквідацій | Розрахунок зі свінг-точок | Squeeze/cascade рівні ризику |

### ML Ensemble (XGBoost + LightGBM + CatBoost)
- **3 моделі голосують разом** — усереднені ймовірності для стабільніших сигналів
- **37 фічей** загалом (21 базових + 12 мульти-ТФ + 7 контекстних включно з order book)
- **Triple-barrier labeling** — мітки на основі майбутнього руху ціни (масштабовані ATR)
- **Time-series крос-валідація** — 5 фолдів на кожну модель, дотримується часової послідовності
- **Збалансовані ваги класів** — коригує дисбаланс BUY/SELL/HOLD
- Навчається на ~100K зразках з 10 пар (~35 днів 5m даних)
- Кожна модель вчиться по-різному → ансамбль зменшує хибні сигнали

### LLM-аналіз (OpenAI)
- **Професійний decision framework** з 6 кроками:
  1. Тренд (напрямок 1H EMA)
  2. Підтвердження моментуму (RSI + ADX)
  3. Smart Money сигнали (L/S ratio, funding)
  4. Магніти ліквідацій (цінові цілі)
  5. Тиск Order Book (bid/ask дисбаланс)
  6. Макро фільтр (домінація стейблів)
- Повертає JSON: напрямок, впевненість (1-10), обґрунтування, ключові рівні, оцінка ризику, режим ринку
- Rate-limited по кожній парі (налаштовуваний інтервал)
- Працює як "фільтр здорового глузду" — блокує сигнали коли макро контекст не погоджується

### Фільтри сигналів
| Фільтр | Що робить | За замовч. |
|--------|-----------|-----------|
| **Volume** | Блокує при об'ємі < 80% від середнього | 0.8 |
| **ADX** | Блокує якщо ADX < 15 (немає тренду) | 15 |
| **EMA Тренд** | Блокує LONG при EMA9 < EMA21 (ведмежий), SHORT при EMA9 > EMA21 (бичачий) | ON |
| **Order Book** | Блокує проти сильного тиску стакану (>0.5 дисбаланс) | 0.5 |
| **NYSE Protection** | Закриває угоди + блокує нові сигнали під час відкриття NYSE (авто-DST) | Авто `[13,14,15]` / `[12,13,14]` |

### 1m Entry Refinement
Після 5m сигналу бот перевіряє 1m свічки для кращого входу:
- **RSI oversold/overbought** на 1m → вхід на відкаті
- **Дотик EMA-9** на 1m → вхід на підтримці/опорі
- **Дотик Bollinger Band** на 1m → вхід на екстремумі
- SL/TP по 5m ATR (узгоджено з генератором сигналів)
- **Мінімальний SL floor** — стоп не менше 0.3% від ціни входу (захист від шумових виносів)
- Якщо відкату немає — вхід по ринку

### Трекінг сигналів та свіжість
| Статус | Значення |
|--------|----------|
| **FRESH SIGNAL** | Щойно з'явився — найкращий момент для входу |
| **NEW ~Xm** | Активний X хвилин — ще можна входити |
| **LATE ~Xm** | Сигнал працює 15+ хвилин — рух частково пройдений |
| **ACTIVE HH:MM** | Відстежується з першої появи, показує оригінальні рівні |

### Моніторинг угод (Trailing Stop + Health + Early Exit)
Активне управління угодами — працює і в live сканері, і в бектесті:

| Функція | Що робить |
|---------|-----------|
| **Trailing Stop** | Рухає SL на вашу користь після 2.0x ATR профіту; тримає на відстані 1.5x ATR |
| **Протилежний сигнал** | Автозакриття якщо ML розвернувся з >65% впевненістю (тільки в прибутку) |
| **RSI Дивергенція** | Виявляє розворот моментуму: RSI відновлюється +15 від екстремуму поки ціна стоїть → CLOSE_EARLY |
| **Funding Squeeze** | Закриває SHORT якщо funding < -0.03% (натовп у шорті, ризик сквізу) |
| **L/S Squeeze** | Закриває SHORT якщо L/S ratio < 0.8 (всі в шорті, ризик сквізу) |
| **Health Check** | Перевіряє RSI екстремуми, ADX, volume кожен скан: HEALTHY → WEAKENING → CLOSE_EARLY |
| **Auto-Track** | Live сканер автоматично починає моніторинг коли з'являється FRESH >55% |

Відображення в консолі:
```
╭───────────────── Відкриті угоди (1) ──────────────────╮
│  BNB/USDT SHORT  Entry 617.85 → Now 616.20 +0.27%    │
│  Trail SL: 617.00  |  HEALTHY  |  15min               │
╰───────────────────────────────────────────────────────╯
```

### Гібридна генерація сигналів
- ML сигнал (60% вага) + LLM сигнал (40% вага) — зважене голосування
- **Бонус згоди** (+20% впевненість) коли обидва погоджуються
- **Незгода = NEUTRAL** — коли ML і LLM суперечать, бот не входить
- SL/TP на основі ATR (SL = 1.5x ATR, TP = 2.5x ATR → R:R = 1:1.67, оптимізовано бектестом)
- **Мінімальний SL floor** 0.3% — захист від тісних стопів при низькому ATR
- Динамічне плече на основі впевненості та рівня ризику

### Paper та Live Trading
| Режим | Що робить |
|-------|-----------|
| **`TRADING_MODE=paper`** | Логує угоди в `paper_trades.json`, без реальних ордерів. Безпечно для тестів. |
| **`TRADING_MODE=live`** | Автоматичні market ордери на Binance з SL/TP. Реальні гроші! |

Обидва режими мають:
- **Миттєве виконання** — ордер відкривається як тільки пара просканована (~6-8 сек)
- **Розмір позиції** на основі `TRADE_BALANCE_USDT` та ризику на угоду
- **Ліміт відкритих угод** (за замовч. 3 одночасних позиції)
- **Денний ліміт збитків** — зупиняє торгівлю при перевищенні 3%
- Paper trades зберігаються між перезапусками (`paper_trades.json`)

### Паралельне виконання
- **Live сканер**: 10 пар одночасно (~8 сек замість ~60 послідовно)
- **Навчання**: 10 пар завантажуються та обробляються паралельно з live таблицею
- **Бектестинг**: 10 пар тестуються паралельно з live прогресом

### Управління ризиками
- Налаштовуваний ризик на угоду (за замовч. 1%)
- Максимальний денний збиток (за замовч. 3%)
- Розмір позиції на основі відстані SL
- Плече обмежене впевненістю та оцінкою ризику

### Бектестинг
- **Out-of-sample**: навчання на 70%, тест на невидимих 30%
- **Реалістичне виконання**: вхід по open наступної свічки, комісії (0.08%), проскальзування (0.01%)
- **Trailing stop + early exit** активні в бектесті (так само як в live)
- **Всі фільтри включені**: volume, ADX, EMA тренд, dead hours
- **LLM бектест**: окремий скрипт для тестування з GPT аналізом на кожну угоду
- **Причини виходу**: TP, SL, Trail SL, Early Exit, Timeout, Dead Hour
- **Dead hour protection**: закриває угоди + блокує нові під час відкриття NYSE (13:00–15:00 UTC)
- **Результат бектесту**: ~+95% net PnL за ~10 днів (out-of-sample, після комісій, Win Rate 67%, Sharpe 17.4, Profit Factor 1.84)

### Авто-переобучення
- `auto_retrain.py` — навчає нову модель на свіжих даних
- Порівнює accuracy з поточною моделлю
- Замінює тільки якщо нова краща (або рівна)
- Історія в `models/retrain_history.json`
- Готовий для cron: кожні 2 дні автоматично

## Структура проєкту

```
aibot/
├── src/
│   ├── config.py           # Всі налаштування (API ключі, пари, таймфрейми, пороги)
│   ├── data_fetcher.py     # Завантаження даних Binance Futures (OHLCV, funding, ticker)
│   ├── indicators.py       # Розрахунок технічних індикаторів (pandas_ta)
│   ├── features.py         # Фіча-інженерія, лейблінг, балансування класів
│   ├── ml_model.py         # ML ансамбль (навчання, прогноз, збереження/завантаження)
│   ├── llm_analyzer.py     # Інтеграція OpenAI (decision framework → JSON)
│   ├── market_context.py   # OI, L/S ratio, домінація CoinGecko, стакан, зони ліквідацій
│   ├── signal_generator.py # Гібридне поєднання сигналів + фільтри (ML + LLM → Signal)
│   ├── entry_refiner.py    # 1m entry refinement (відкат, дотик EMA/BB)
│   ├── trade_monitor.py    # Trailing stop, аналіз здоров'я, early exit
│   ├── executor.py         # Paper/live виконання ордерів (Binance)
│   ├── risk_manager.py     # Розмір позиції, денні ліміти збитків
│   └── display.py          # Rich консольний вивід (таблиці, панелі, моніторинг угод)
├── models/                 # Збережені ML моделі (.json + .pkl метадані)
├── main.py                 # Live сканер (цикл або --once)
├── train.py                # Пайплайн навчання ML
├── backtest.py             # Реалістичний out-of-sample бектестер
├── backtest_llm.py         # LLM бектест (GPT аналіз на кожну угоду)
├── auto_retrain.py         # Авто-переобучення з порівнянням accuracy
├── deploy.sh               # Скрипт деплою на сервер одною командою
├── requirements.txt
├── .env.example
└── .gitignore
```

## Швидкий старт

### 1. Встановити залежності

```bash
pip install -r requirements.txt
```

### 2. Налаштувати середовище

```bash
cp .env.example .env
```

Відредагувати `.env`:
```env
BINANCE_API_KEY=ваш_ключ
BINANCE_SECRET=ваш_секрет
BINANCE_TESTNET=false
OPENAI_API_KEY=ваш_openai_ключ
OPENAI_MODEL=gpt-4o-mini
```

### 3. Навчити ML модель

```bash
python train.py
```

### 4. Запустити сканер

```bash
python main.py          # безперервне сканування кожні 5 хв
python main.py --once   # один скан і вихід
```

### 5. Бектест

```bash
python backtest.py                          # всі 10 пар, out-of-sample
python backtest.py --pair BTC/USDT          # одна пара
python backtest.py --no-filters             # порівняти без фільтрів
python backtest_llm.py --pair ETH/USDT      # з LLM аналізом на кожну угоду
```

### 6. Деплой на сервер

```bash
scp -r . root@ВАШ_СЕРВЕР:/root/aibot
ssh root@ВАШ_СЕРВЕР "cd /root/aibot && bash deploy.sh"
```

## Конфігурація

Всі налаштування в `src/config.py`, перевизначаються через `.env`:

| Параметр | За замовч. | Опис |
|----------|-----------|------|
| `TRADING_PAIRS` | 10 топ пар | Ф'ючерсні пари для сканування |
| `PRIMARY_TIMEFRAME` | `5m` | Основний таймфрейм сигналів |
| `PREDICTION_THRESHOLD` | `0.55` | Мін. впевненість для сигналу (оптимізовано бектестом) |
| `SL_ATR_MULTIPLIER` | `1.5` | Стоп-лос = ATR × це |
| `TP_ATR_MULTIPLIER` | `2.5` | Тейк-профіт = ATR × це (R:R = 1:1.67) |
| `MIN_SL_PCT` | `0.3` | Мінімальна відстань SL у % (floor для низького ATR) |
| `MAX_HOLD_BARS` | `12` | Макс. час утримання (60 хв на 5m) |
| `SCAN_INTERVAL` | `300` | Секунди між сканами |
| `USE_LLM` | `True` | Увімкнути/вимкнути LLM |
| `USE_1M_ENTRY` | `True` | Увімкнути 1m entry refinement |
| `FILTER_MIN_VOLUME_RATIO` | `0.8` | Поріг фільтру об'єму |
| `FILTER_MIN_ADX` | `15.0` | Поріг фільтру ADX |
| `FILTER_TREND_EMA` | `True` | Блокувати сигнали проти тренду EMA9/EMA21 |
| `FILTER_DEAD_HOURS` | Авто (DST) | NYSE open ± 1г, автоматично підлаштовується під зиму/літо |
| `EXTRA_DEAD_HOURS` | `""` | Додаткові UTC години через `.env` (напр. `2,3,4`) |
| `TRAILING_ACTIVATION_ATR` | `2.0` | Активувати trailing після 2.0x ATR профіту |
| `TRAILING_DISTANCE_ATR` | `1.5` | Trailing SL на відстані 1.5x ATR за найкращою ціною |
| `TRADING_MODE` | `paper` | `paper` = тільки логи, `live` = реальні ордери Binance |
| `TRADE_BALANCE_USDT` | `100` | Баланс для розміру позиції |
| `MAX_OPEN_TRADES` | `3` | Макс. одночасних позицій |
| `RISK_PER_TRADE` | `0.01` | 1% ризику на угоду |
| `MAX_DAILY_LOSS` | `0.03` | 3% ліміт денних збитків |

## Технології

- **Python 3.12+**
- **ccxt** — уніфікований API криптобірж (Binance USDM Futures)
- **pandas + pandas_ta** — обробка даних та технічні індикатори
- **XGBoost + LightGBM + CatBoost** — ансамбль з 3 gradient boosting класифікаторів
- **scikit-learn** — time-series крос-валідація, метрики
- **OpenAI API** — GPT-4o-mini з професійним trading decision framework
- **CoinGecko API** — глобальні ринкові дані (безкоштовно, без auth)
- **Binance Futures API** — OI, L/S ratio, стакан (безкоштовно, без auth)
- **Rich** — красивий термінальний вивід з трекінгом сигналів

## Відмова від відповідальності

Це ПЗ призначене **лише для навчальних та дослідницьких цілей**. Торгівля криптовалютними ф'ючерсами пов'язана зі значними ризиками. Минулі результати ML моделі не гарантують майбутніх результатів. Завжди проводьте власне дослідження та починайте з малих сум. Автори не несуть відповідальності за фінансові збитки, понесені при використанні цього ПЗ.
